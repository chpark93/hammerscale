<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hammerscale - Test Report</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #3a3a3a;
        }

        .header h1 {
            color: #4ade80;
            font-size: 2em;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #4ade80;
            border-radius: 5px;
            font-size: 1em;
            color: #e0e0e0;
            font-family: monospace;
        }

        .input-group button {
            padding: 12px 30px;
            background: #4ade80;
            color: #1a1a1a;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            font-family: monospace;
        }

        .input-group button:hover {
            background: #22c55e;
        }

        .report-section {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #3a3a3a;
        }

        .report-section h2 {
            color: #4ade80;
            margin-bottom: 20px;
            font-size: 1.5em;
            font-family: monospace;
        }

        .hammerscale-header {
            border-bottom: 2px solid #4ade80;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .hammerscale-summary-line {
            display: grid;
            grid-template-columns: 250px 1fr;
            padding: 8px 0;
            border-bottom: 1px solid #3a3a3a;
            font-family: monospace;
        }

        .hammerscale-summary-line:last-child {
            border-bottom: none;
        }

        .hammerscale-label {
            color: #94a3b8;
        }

        .hammerscale-value {
            color: #e0e0e0;
            font-weight: bold;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3a3a3a;
        }

        .metric-card h3 {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #4ade80;
            font-family: monospace;
        }

        .metric-unit {
            font-size: 0.4em;
            color: #94a3b8;
            margin-left: 5px;
        }

        .metric-details {
            margin-top: 10px;
            font-size: 0.85em;
            color: #94a3b8;
            font-family: monospace;
        }

        .threshold-item {
            display: grid;
            grid-template-columns: 300px 150px 150px;
            padding: 12px;
            border-bottom: 1px solid #3a3a3a;
            font-family: monospace;
        }

        .threshold-item:last-child {
            border-bottom: none;
        }

        .threshold-name {
            color: #e0e0e0;
        }

        .threshold-expected {
            color: #94a3b8;
        }

        .threshold-actual {
            font-weight: bold;
        }

        .threshold-pass {
            color: #4ade80;
        }

        .threshold-fail {
            color: #ef4444;
        }

        .alert-box {
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            font-family: monospace;
        }

        .alert-success {
            background: #14532d;
            border-color: #4ade80;
            color: #4ade80;
        }

        .alert-warning {
            background: #431407;
            border-color: #f59e0b;
            color: #fbbf24;
        }

        .alert-danger {
            background: #450a0a;
            border-color: #ef4444;
            color: #f87171;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            font-family: monospace;
        }

        .badge-healthy {
            background: #14532d;
            color: #4ade80;
        }

        .badge-degraded {
            background: #431407;
            color: #fbbf24;
        }

        .badge-critical {
            background: #450a0a;
            color: #f87171;
        }

        .badge-failed {
            background: #450a0a;
            color: #ef4444;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #4ade80;
        }

        .hidden {
            display: none;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-line {
            padding: 12px;
            background: #1a1a1a;
            border-radius: 5px;
            font-family: monospace;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 0.9em;
        }

        .stat-value {
            color: #e0e0e0;
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 5px;
        }

        .link-button {
            display: inline-block;
            padding: 10px 20px;
            background: #4ade80;
            color: #1a1a1a;
            text-decoration: none;
            border-radius: 5px;
            margin-top: 10px;
            transition: background 0.3s;
            font-family: monospace;
            font-weight: bold;
        }

        .link-button:hover {
            background: #22c55e;
        }

        .percentile-table {
            width: 100%;
            margin-top: 15px;
        }

        .percentile-table td {
            padding: 8px 12px;
            font-family: monospace;
        }

        .percentile-table .label {
            color: #94a3b8;
            width: 100px;
        }

        .percentile-table .value {
            color: #e0e0e0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ö° Test Report</h1>
            <p style="color: #94a3b8;">Powered by Hammerscale</p>
            
            <div class="input-group">
                <input type="text" id="testIdInput" placeholder="Enter Test ID" />
                <button onclick="loadReport()">Load Report</button>
            </div>
        </div>

        <div id="loading" class="report-section loading hidden">
            Loading report...
        </div>

        <div id="reportContent" class="hidden">
            <!-- Test Overview -->
            <div class="report-section">
                <div class="hammerscale-header">
                    <h2>execution: local</h2>
                    <div style="color: #94a3b8; font-family: monospace;">
                        script: <span id="testTitle" style="color: #e0e0e0;">-</span><br/>
                        output: Hammerscale InfluxDB
                    </div>
                </div>

                <div class="hammerscale-summary-line">
                    <div class="hammerscale-label">test_id</div>
                    <div class="hammerscale-value" id="testId">-</div>
                </div>
                <div class="hammerscale-summary-line">
                    <div class="hammerscale-label">test_type</div>
                    <div class="hammerscale-value" id="testType">-</div>
                </div>
                <div class="hammerscale-summary-line">
                    <div class="hammerscale-label">status</div>
                    <div class="hammerscale-value"><span id="statusBadge" class="status-badge badge-healthy">-</span></div>
                </div>
                <div class="hammerscale-summary-line">
                    <div class="hammerscale-label">duration</div>
                    <div class="hammerscale-value" id="duration">-</div>
                </div>
                <div class="hammerscale-summary-line">
                    <div class="hammerscale-label">health_status</div>
                    <div class="hammerscale-value"><span id="healthStatus" class="status-badge badge-healthy">-</span></div>
                </div>
            </div>

            <!-- HTTP Metrics -->
            <div class="report-section">
                <h2>üìä http_reqs</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Total Requests</h3>
                        <div class="metric-value" id="totalRequests">0</div>
                        <div class="metric-details">
                            Success: <span id="successRequests" style="color: #4ade80;">0</span> | 
                            Failed: <span id="failedRequests" style="color: #ef4444;">0</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3>Request Rate</h3>
                        <div class="metric-value" id="requestRate">0<span class="metric-unit">req/s</span></div>
                    </div>
                </div>
            </div>

            <!-- Latency Metrics -->
            <div class="report-section">
                <h2>‚è±Ô∏è http_req_duration</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Average</h3>
                        <div class="metric-value" id="avgLatency">0<span class="metric-unit">ms</span></div>
                    </div>
                    <div class="metric-card">
                        <h3>Median (p50)</h3>
                        <div class="metric-value" id="medianLatency">0<span class="metric-unit">ms</span></div>
                    </div>
                    <div class="metric-card">
                        <h3>p95</h3>
                        <div class="metric-value" id="p95Latency">0<span class="metric-unit">ms</span></div>
                    </div>
                    <div class="metric-card">
                        <h3>p99</h3>
                        <div class="metric-value" id="p99Latency">0<span class="metric-unit">ms</span></div>
                    </div>
                </div>
                <table class="percentile-table">
                    <tr>
                        <td class="label">min</td>
                        <td class="value" id="minLatency">-</td>
                        <td class="label">max</td>
                        <td class="value" id="maxLatency">-</td>
                    </tr>
                    <tr>
                        <td class="label">p90</td>
                        <td class="value" id="p90Latency">-</td>
                        <td class="label">avg</td>
                        <td class="value" id="avgLatency2">-</td>
                    </tr>
                </table>
            </div>

            <!-- VUs & TPS -->
            <div class="report-section">
                <h2>üë• Virtual Users & TPS</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <h3>Virtual Users</h3>
                        <div class="metric-value" id="vus">0</div>
                        <div class="metric-details">
                            min: <span id="vusMin">0</span> | 
                            max: <span id="vusMax">0</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3>TPS (avg)</h3>
                        <div class="metric-value" id="tpsAvg">0<span class="metric-unit">req/s</span></div>
                        <div class="metric-details">
                            min: <span id="tpsMin">0</span> | 
                            max: <span id="tpsMax">0</span>
                        </div>
                    </div>
                    <div class="metric-card">
                        <h3>Error Rate</h3>
                        <div class="metric-value" id="errorRate">0<span class="metric-unit">%</span></div>
                        <div class="metric-details">
                            avg: <span id="errorRateAvg">0%</span> | 
                            max: <span id="errorRateMax">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Thresholds -->
            <div class="report-section">
                <h2>‚úì Checks & Thresholds</h2>
                <div id="thresholdsOverall" class="alert-box alert-success">
                    <strong>‚úì All thresholds passed</strong>
                </div>
                <div id="thresholdsList"></div>
            </div>

            <!-- Breaking Point -->
            <div id="breakingPointSection" class="report-section hidden">
                <h2>üî• Breaking Point Detection</h2>
                <div class="alert-box alert-danger">
                    <strong>‚ö†Ô∏è System reached its breaking point!</strong>
                    <p id="breakingPointMessage"></p>
                </div>
                <div class="summary-stats">
                    <div class="stat-line">
                        <div class="stat-label">Active Users</div>
                        <div class="stat-value" id="bpUsers">-</div>
                    </div>
                    <div class="stat-line">
                        <div class="stat-label">Health Status</div>
                        <div class="stat-value" id="bpStatus">-</div>
                    </div>
                    <div class="stat-line">
                        <div class="stat-label">TPS</div>
                        <div class="stat-value" id="bpTps">-</div>
                    </div>
                    <div class="stat-line">
                        <div class="stat-label">Latency</div>
                        <div class="stat-value" id="bpLatency">-</div>
                    </div>
                    <div class="stat-line">
                        <div class="stat-label">Error Rate</div>
                        <div class="stat-value" id="bpErrorRate">-</div>
                    </div>
                    <div class="stat-line">
                        <div class="stat-label">Timestamp</div>
                        <div class="stat-value" style="font-size: 0.9em;" id="bpTimestamp">-</div>
                    </div>
                </div>
            </div>

            <!-- TPS Saturation -->
            <div id="tpsSaturationSection" class="report-section hidden">
                <h2>üìâ TPS Saturation Detection</h2>
                <div class="alert-box alert-warning">
                    <strong>‚ö†Ô∏è TPS saturation detected!</strong>
                    <p id="tpsSaturationMessage"></p>
                </div>
                <div class="summary-stats">
                    <div class="stat-line">
                        <div class="stat-label">Active Users at Saturation</div>
                        <div class="stat-value" id="satUsers">-</div>
                    </div>
                    <div class="stat-line">
                        <div class="stat-label">Max TPS</div>
                        <div class="stat-value" id="satMaxTps">-</div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="report-section">
                <a href="#" id="dashboardLink" class="link-button">üìä View Dashboard History</a>
                <a href="/" class="link-button" style="background: #3a3a3a; color: #e0e0e0; margin-left: 10px;">üè† New Test</a>
            </div>
        </div>
    </div>

    <script>
        function loadReport() {
            const testId = document.getElementById('testIdInput').value.trim();
            if (!testId) {
                alert('Please enter a Test ID');
                return;
            }

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('reportContent').classList.add('hidden');

            fetch(`/api/result/${testId}`)
                .then(async response => {
                    if (!response.ok) {
                        const errorText = await response.text();
                        
                        // ÌÖåÏä§Ìä∏Í∞Ä ÏïÑÏßÅ ÏßÑÌñâ Ï§ëÏù∏ Í≤ΩÏö∞
                        if (errorText.includes('not finished yet') || errorText.includes('RUNNING')) {
                            document.getElementById('loading').innerHTML = `
                                <div style="text-align: center;">
                                    <h3 style="color: #4ade80; margin-bottom: 20px;">‚è≥ Test is still running</h3>
                                    <p style="color: #94a3b8; margin-bottom: 30px;">
                                        This test has not completed yet.<br/>
                                        Please wait for the test to finish or view real-time progress.
                                    </p>
                                    <a href="/dashboard.html?testId=${testId}" 
                                       style="display: inline-block; padding: 12px 30px; background: #4ade80; 
                                              color: #1a1a1a; text-decoration: none; border-radius: 5px; 
                                              font-weight: bold; font-family: monospace;">
                                        üìä View Real-time Dashboard
                                    </a>
                                </div>
                            `;
                            return null;
                        }
                        
                        throw new Error(errorText || 'Failed to load report');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data) {
                        displayReport(data);
                        document.getElementById('loading').classList.add('hidden');
                        document.getElementById('reportContent').classList.remove('hidden');
                    }
                })
                .catch(error => {
                    document.getElementById('loading').innerHTML = `
                        <div style="text-align: center; color: #ef4444;">
                            <h3>‚ùå Error</h3>
                            <p>${error.message}</p>
                            <a href="/" style="color: #4ade80; text-decoration: underline; margin-top: 20px; display: inline-block;">
                                Go back to home
                            </a>
                        </div>
                    `;
                });
        }

        function displayReport(data) {
            console.log('Report data:', data);

            // Overview
            document.getElementById('testId').textContent = data.testId;
            document.getElementById('testType').textContent = data.testType;
            document.getElementById('testTitle').textContent = data.testType + ' Test';
            document.getElementById('duration').textContent = data.summary.totalDuration;
            
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = data.status;
            statusBadge.className = 'status-badge badge-' + data.status.toLowerCase();

            const healthBadge = document.getElementById('healthStatus');
            healthBadge.textContent = data.summary.healthStatus;
            healthBadge.className = 'status-badge badge-' + data.summary.healthStatus.toLowerCase();

            document.getElementById('dashboardLink').href = `/dashboard.html?testId=${data.testId}&fromReport=true`;

            // HTTP Requests
            document.getElementById('totalRequests').textContent = data.metrics.httpReqs.count.toLocaleString();
            document.getElementById('successRequests').textContent = data.metrics.httpReqs.successful.toLocaleString();
            document.getElementById('failedRequests').textContent = data.metrics.httpReqs.failed.toLocaleString();
            document.getElementById('requestRate').innerHTML = `${data.metrics.httpReqs.rate.toFixed(2)}<span class="metric-unit">req/s</span>`;

            // Latency
            document.getElementById('avgLatency').innerHTML = `${data.metrics.httpReqDuration.avg.toFixed(1)}<span class="metric-unit">ms</span>`;
            document.getElementById('avgLatency2').textContent = data.metrics.httpReqDuration.avg.toFixed(1) + 'ms';
            document.getElementById('medianLatency').innerHTML = `${data.metrics.httpReqDuration.med.toFixed(1)}<span class="metric-unit">ms</span>`;
            document.getElementById('p90Latency').textContent = data.metrics.httpReqDuration.p90.toFixed(1) + 'ms';
            document.getElementById('p95Latency').innerHTML = `${data.metrics.httpReqDuration.p95.toFixed(1)}<span class="metric-unit">ms</span>`;
            document.getElementById('p99Latency').innerHTML = `${data.metrics.httpReqDuration.p99.toFixed(1)}<span class="metric-unit">ms</span>`;
            document.getElementById('minLatency').textContent = data.metrics.httpReqDuration.min.toFixed(1) + 'ms';
            document.getElementById('maxLatency').textContent = data.metrics.httpReqDuration.max.toFixed(1) + 'ms';

            // VUs & TPS
            document.getElementById('vus').textContent = data.metrics.vus.value;
            document.getElementById('vusMin').textContent = data.metrics.vus.min;
            document.getElementById('vusMax').textContent = data.metrics.vus.max;
            document.getElementById('tpsAvg').innerHTML = `${data.metrics.tps.avg.toFixed(1)}<span class="metric-unit">req/s</span>`;
            document.getElementById('tpsMin').textContent = data.metrics.tps.min;
            document.getElementById('tpsMax').textContent = data.metrics.tps.max;
            document.getElementById('errorRate').innerHTML = `${(data.metrics.errorRate.value * 100).toFixed(2)}<span class="metric-unit">%</span>`;
            document.getElementById('errorRateAvg').textContent = (data.metrics.errorRate.avg * 100).toFixed(2) + '%';
            document.getElementById('errorRateMax').textContent = (data.metrics.errorRate.max * 100).toFixed(2) + '%';

            // Thresholds
            const thresholdsOverall = document.getElementById('thresholdsOverall');
            const thresholdsList = document.getElementById('thresholdsList');
            thresholdsList.innerHTML = '';

            if (data.thresholds.passed) {
                thresholdsOverall.className = 'alert-box alert-success';
                thresholdsOverall.innerHTML = '<strong>‚úì All thresholds passed</strong>';
            } else {
                thresholdsOverall.className = 'alert-box alert-danger';
                thresholdsOverall.innerHTML = '<strong>‚úó Some thresholds failed</strong>';
            }

            Object.keys(data.thresholds.results).forEach(key => {
                const threshold = data.thresholds.results[key];
                const item = document.createElement('div');
                item.className = 'threshold-item';
                
                const statusClass = threshold.passed ? 'threshold-pass' : 'threshold-fail';
                const statusIcon = threshold.passed ? '‚úì' : '‚úó';
                
                item.innerHTML = `
                    <div class="threshold-name">${statusIcon} ${key}</div>
                    <div class="threshold-expected">${threshold.threshold}</div>
                    <div class="threshold-actual ${statusClass}">${threshold.value}</div>
                `;
                thresholdsList.appendChild(item);
            });

            // Breaking Point
            if (data.breakingPoint.detected) {
                document.getElementById('breakingPointSection').classList.remove('hidden');
                const bp = data.breakingPoint;
                document.getElementById('breakingPointMessage').textContent = 
                    `System reached ${bp.healthStatus} status with ${bp.activeUsers} active users`;
                document.getElementById('bpUsers').textContent = bp.activeUsers;
                document.getElementById('bpStatus').textContent = bp.healthStatus;
                document.getElementById('bpTps').textContent = bp.tps;
                document.getElementById('bpLatency').textContent = bp.latency.toFixed(1) + ' ms';
                document.getElementById('bpErrorRate').textContent = (bp.errorRate * 100).toFixed(2) + ' %';
                document.getElementById('bpTimestamp').textContent = new Date(bp.timestamp).toLocaleString();
            }

            // TPS Saturation
            if (data.tpsSaturation.detected) {
                document.getElementById('tpsSaturationSection').classList.remove('hidden');
                const sat = data.tpsSaturation;
                document.getElementById('tpsSaturationMessage').textContent = 
                    `TPS peaked at ${sat.maxTps} with ${sat.activeUsers} active users`;
                document.getElementById('satUsers').textContent = sat.activeUsers;
                document.getElementById('satMaxTps').textContent = sat.maxTps;
            }
        }

        // Auto-load if testId is in URL
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const testId = params.get('testId');
            if (testId) {
                document.getElementById('testIdInput').value = testId;
                loadReport();
            }
        });
    </script>
</body>
</html>
