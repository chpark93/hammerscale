syntax = "proto3";

package com.project.common.proto;

option java_multiple_files = true;
option java_package = "com.project.common.proto";
option java_outer_classname = "LoadTestProto";

// Controller -> Agent 명령
service AgentService {
  // 테스트 시작 명령
  rpc StartTest (TestConfig) returns (Ack);
  // 테스트 중단
  rpc StopTest (TestId) returns (Ack);
  // 헬스 체크
  rpc Ping (Empty) returns (Pong);
}

// Agent -> Controller 보고
service ReportService {
  // 실시간 통계 전송
  rpc StreamStats (stream TestStat) returns (Ack);
}

message TestConfig {
  string testId = 1;
  string targetUrl = 2;
  int32 virtualUsers = 3; // 동시 접속자 수 (LOAD 테스트에서 사용)
  int32 durationSeconds = 4; // 테스트 지속 시간 (LOAD 테스트에서 사용)
  string httpMethod = 5;
  map<string, string> headers = 6; // HTTP 헤더
  map<string, string> queryParams = 7; // Query Parameters
  string requestBody = 8; // Request Body (JSON 등)
  int32 rampUpSeconds = 9; // Ramp-up 시간 (LOAD 테스트에서 사용, 0 = 즉시 시작)
  string testType = 10; // 테스트 타입 (LOAD, STRESS, SPIKE)
  StressTestConfig stressTestConfig = 11; // Stress 테스트 설정
  SpikeTestConfig spikeTestConfig = 12; // Spike 테스트 설정
}

message StressTestConfig {
  int32 startUsers = 1; // 시작 사용자 수
  int32 maxUsers = 2; // 최대 사용자 수
  int32 stepDuration = 3; // 각 단계 지속 시간 (초)
  int32 stepIncrement = 4; // 각 단계마다 증가할 사용자 수
}

message SpikeTestConfig {
  int32 baseUsers = 1; // 기본 사용자 수 (평소 트래픽)
  int32 spikeUsers = 2; // 급증 시 사용자 수 (피크 트래픽)
  int32 spikeDuration = 3; // 급증 유지 시간 (초)
  int32 recoveryDuration = 4; // 회복 시간 (초)
}

message TestStat {
  string testId = 1;
  int64 timestamp = 2;
  int32 activeUsers = 3;
  int32 requestsPerSecond = 4; // TPS
  double avgLatencyMs = 5; // 평균 응답 속도
  double p50LatencyMs = 6; // 50th percentile
  double p95LatencyMs = 7; // 95th percentile
  double p99LatencyMs = 8; // 99th percentile
  int32 errorCount = 9;
  string healthStatus = 10; // HEALTHY, DEGRADED, CRITICAL, FAILED
  double errorRate = 11; // 에러율 (0.0 ~ 1.0)
}

message TestId { string id = 1; }
message Ack { bool success = 1; string message = 2; }
message Empty {}
message Pong { bool alive = 1; }